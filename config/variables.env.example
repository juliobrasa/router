#!/bin/bash
################################################################################
# Variables de Configuración - WireGuard Tunnel System
# Copiar a variables.env y editar con tus valores
################################################################################

# =============================================================================
# INFORMACIÓN DEL VPS (DATACENTER)
# =============================================================================

# IP pública principal del VPS
VPS_PUBLIC_IP="X.X.X.X"

# IPs públicas adicionales (una por línea, entre comillas)
# Estas serán las IPs que se mapearán a las VMs en la oficina
VPS_ADDITIONAL_IPS=(
    "Y.Y.Y.1"
    "Y.Y.Y.2"
    "Y.Y.Y.3"
    "Y.Y.Y.4"
    "Y.Y.Y.5"
    # Agregar más según sea necesario...
)

# Interfaz de red principal del VPS (típicamente eth0 o ens3)
VPS_INTERFACE="eth0"

# =============================================================================
# CONFIGURACIÓN WIREGUARD - VPS
# =============================================================================

# Puerto UDP para WireGuard (51820 es el estándar)
WG_PORT="51820"

# IP de la red del túnel WireGuard
# Red privada exclusiva para el túnel
WG_NETWORK="10.200.0.0/24"
WG_VPS_IP="10.200.0.1"        # IP del VPS en el túnel
WG_MIKROTIK_IP="10.200.0.2"   # IP del MikroTik en el túnel

# =============================================================================
# INFORMACIÓN DE LA OFICINA
# =============================================================================

# IP pública fija de la oficina (donde está el MikroTik)
OFFICE_PUBLIC_IP="Z.Z.Z.Z"

# IP interna del MikroTik en la red de la oficina
MIKROTIK_INTERNAL_IP="192.168.88.1"

# Usuario admin del MikroTik
MIKROTIK_USER="admin"

# =============================================================================
# RED PROXMOX (OFICINA)
# =============================================================================

# Red interna de Proxmox (donde están las VMs)
PROXMOX_NETWORK="10.100.0.0/24"

# Gateway de la red de Proxmox (típicamente el MikroTik)
PROXMOX_GATEWAY="10.100.0.1"

# IPs privadas de las VMs en Proxmox
# Deben corresponder 1:1 con VPS_ADDITIONAL_IPS
VM_IPS=(
    "10.100.0.11"  # Esta VM usará Y.Y.Y.1
    "10.100.0.12"  # Esta VM usará Y.Y.Y.2
    "10.100.0.13"  # Esta VM usará Y.Y.Y.3
    "10.100.0.14"  # Esta VM usará Y.Y.Y.4
    "10.100.0.15"  # Esta VM usará Y.Y.Y.5
    # Agregar más según sea necesario...
)

# Nombres descriptivos de las VMs (opcional, para documentación)
VM_NAMES=(
    "web-server-1"
    "web-server-2"
    "database-1"
    "app-server-1"
    "mail-server-1"
)

# =============================================================================
# DNS (OPCIONAL)
# =============================================================================

# Servidores DNS para las VMs
DNS_SERVERS="8.8.8.8,1.1.1.1"

# =============================================================================
# CONFIGURACIÓN DE LOGS Y MONITOREO
# =============================================================================

# Habilitar logs detallados (true/false)
ENABLE_DETAILED_LOGS="true"

# Directorio para logs personalizados
LOG_DIR="/var/log/wireguard-tunnel"

# Email para alertas (opcional)
ALERT_EMAIL="admin@example.com"

# =============================================================================
# LÍMITES Y OPTIMIZACIÓN
# =============================================================================

# Límite de ancho de banda por VM (en Mbit/s, 0 = sin límite)
# Usar con tc (traffic control)
BANDWIDTH_LIMIT_PER_VM="0"

# MTU para WireGuard (típicamente 1420 para evitar fragmentación)
WG_MTU="1420"

# =============================================================================
# NOTAS Y VALIDACIONES
# =============================================================================

# IMPORTANTE:
# 1. VPS_ADDITIONAL_IPS y VM_IPS deben tener la misma cantidad de elementos
# 2. El mapeo es 1:1 en orden: VPS_ADDITIONAL_IPS[0] → VM_IPS[0]
# 3. OFFICE_PUBLIC_IP debe ser una IP pública fija y estable
# 4. WG_PORT debe estar abierto en firewall del VPS (UDP)
# 5. Las redes WG_NETWORK y PROXMOX_NETWORK no deben solaparse

# VALIDACIONES (no editar)
_validate_config() {
    local error_count=0

    # Validar que hay la misma cantidad de IPs públicas que privadas
    if [ ${#VPS_ADDITIONAL_IPS[@]} -ne ${#VM_IPS[@]} ]; then
        echo "ERROR: VPS_ADDITIONAL_IPS (${#VPS_ADDITIONAL_IPS[@]}) y VM_IPS (${#VM_IPS[@]}) deben tener la misma cantidad"
        ((error_count++))
    fi

    # Validar que las IPs públicas del VPS están configuradas
    if [ "$VPS_PUBLIC_IP" = "X.X.X.X" ]; then
        echo "ERROR: VPS_PUBLIC_IP no está configurada"
        ((error_count++))
    fi

    # Validar que la IP pública de oficina está configurada
    if [ "$OFFICE_PUBLIC_IP" = "Z.Z.Z.Z" ]; then
        echo "ERROR: OFFICE_PUBLIC_IP no está configurada"
        ((error_count++))
    fi

    if [ $error_count -gt 0 ]; then
        echo "Total de errores de configuración: $error_count"
        return 1
    fi

    return 0
}

# Descomentar para validar al cargar el archivo
# _validate_config || exit 1
